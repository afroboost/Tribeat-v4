// Tribeat Database Schema
// PostgreSQL avec Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========================================
// USERS & AUTHENTICATION
// ========================================

enum UserRole {
  SUPER_ADMIN
  COACH
  PARTICIPANT
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String   // Hashé avec bcrypt
  role      UserRole @default(PARTICIPANT)
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  coachedSessions  Session[]           @relation("CoachSessions")
  sessionRoles     SessionParticipant[]
  messages         ChatMessage[]
  likes            SessionLike[]
  transactions     Transaction[]
  accesses         UserAccess[]
  ledgerEntries    LedgerEntry[]
  payouts          Payout[]
  promoCodesCreated PromoCode[]        @relation("PromoCodeCreatedBy")
  promoRedemptions PromoRedemption[]
  coachSubscription CoachSubscription?

  @@index([email])
}

// ========================================
// SESSIONS LIVE
// ========================================

enum SessionStatus {
  SCHEDULED
  LIVE
  COMPLETED
  CANCELLED
}

enum MediaType {
  VIDEO
  AUDIO
  IMAGE
}

model Session {
  id          String        @id @default(cuid())
  title       String
  description String?
  coachId     String
  coach       User          @relation("CoachSessions", fields: [coachId], references: [id], onDelete: Cascade)
  
  // Média synchronisé
  mediaUrl    String?       // URL Cloudinary / Vercel Blob ou externe
  mediaType   MediaType?
  
  // Planification
  scheduledAt DateTime
  startedAt   DateTime?
  endedAt     DateTime?
  status      SessionStatus @default(SCHEDULED)
  
  // Métadonnées
  maxParticipants Int?
  isPublic        Boolean @default(true)
  chatDisabled    Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  participants SessionParticipant[]
  messages     ChatMessage[]
  likes        SessionLike[]
  offers       Offer[]
  accesses     UserAccess[]

  @@index([coachId])
  @@index([status])
  @@index([scheduledAt])
}

// ========================================
// MANY-TO-MANY : USER ↔ SESSION
// ========================================

enum ParticipantRole {
  COACH
  PARTICIPANT
  MODERATOR
}

model SessionParticipant {
  id        String          @id @default(cuid())
  userId    String
  sessionId String
  role      ParticipantRole @default(PARTICIPANT)
  joinedAt  DateTime        @default(now())
  leftAt    DateTime?

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([userId, sessionId])
  @@index([sessionId])
  @@index([userId])
}

// ========================================
// CHAT EN TEMPS RÉEL
// ========================================

model ChatMessage {
  id        String   @id @default(cuid())
  sessionId String
  userId    String
  content   String   
  timestamp DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([timestamp])
}

// ========================================
// LIKES (REACTIONS)
// ========================================

model SessionLike {
  id        String   @id @default(cuid())
  sessionId String
  userId    String
  createdAt DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
}

// ========================================
// UI SETTINGS (THÈME DYNAMIQUE)
// ========================================

enum SettingCategory {
  THEME
  PWA
  GENERAL
}

model UI_Settings {
  id       String          @id @default(cuid())
  key      String          @unique
  value    String          
  category SettingCategory
  updatedAt DateTime       @updatedAt

  @@index([category])
}

// ========================================
// TRADUCTIONS (i18n EN BASE)
// ========================================

enum Language {
  FR
  EN
  DE
}

model Translation {
  id       String   @id @default(cuid())
  key      String   // Ex: "session.join_button"
  language Language
  value    String   
  updatedAt DateTime @updatedAt

  @@unique([key, language])
  @@index([language])
}

// ========================================
// OFFERS (PRODUITS PAYANTS)
// ========================================

model Offer {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Int      // En centimes (1000 = 10.00 CHF)
  currency    String   @default("CHF")
  sessionId   String?  // Lié à une session spécifique (optionnel)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  session      Session?      @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  transactions Transaction[]

  @@index([sessionId])
  @@index([isActive])
}

// ========================================
// TRANSACTIONS (STRIPE / MANUAL)
// ========================================

enum TransactionProvider {
  MANUAL
  STRIPE
  PAYSTACK
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Transaction {
  id              String              @id @default(cuid())
  userId          String
  offerId         String?
  amount          Int                 // En centimes (ex: 1000 = 10.00 CHF)
  currency        String              @default("CHF")
  provider        TransactionProvider
  providerTxId    String?             // Stripe Session ID / Checkout ID
  status          TransactionStatus   @default(PENDING)
  metadata        Json?               // Données additionnelles
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  offer      Offer?      @relation(fields: [offerId], references: [id], onDelete: SetNull)
  userAccess UserAccess?
  sessionPayment SessionPayment?
  promoRedemption PromoRedemption?
  ledgerEntries LedgerEntry[]

  @@index([userId])
  @@index([offerId])
  @@index([status])
  @@index([providerTxId])
}

// ========================================
// USER ACCESS (ACCÈS PAYANTS)
// ========================================

enum AccessStatus {
  PENDING
  ACTIVE
  EXPIRED
  REVOKED
}

model UserAccess {
  id            String       @id @default(cuid())
  userId        String
  sessionId     String?      // Accès à une session spécifique
  offerId       String?      // Lié à une offre
  transactionId String?      @unique
  status        AccessStatus @default(PENDING)
  grantedAt     DateTime     @default(now())
  expiresAt     DateTime?    // Null = permanent
  revokedAt     DateTime?
  revokedBy     String?      // ID admin qui a révoqué

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  session     Session?     @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  transaction Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([sessionId])
  @@index([status])
}

// ========================================
// PAYMENTS (NORMALIZED)
// ========================================

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

model SessionPayment {
  id            String        @id @default(cuid())
  transactionId String        @unique
  stripeSessionId String?
  status        PaymentStatus @default(PENDING)
  amount        Int           // signed int cents (PAID is positive)
  currency      String        @default("CHF")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([stripeSessionId])
}

// ========================================
// LEDGER (ACCOUNTING)
// ========================================

enum LedgerEntryType {
  PLATFORM_REVENUE
  COACH_EARNING
  PAYOUT
}

model LedgerEntry {
  id            String          @id @default(cuid())
  type          LedgerEntryType
  amount        Int             // signed int cents
  userId        String?
  transactionId String?
  payoutId      String?
  createdAt     DateTime        @default(now())

  user        User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  transaction Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)
  payout      Payout?      @relation(fields: [payoutId], references: [id], onDelete: SetNull)

  @@unique([transactionId, type])
  @@index([userId])
  @@index([transactionId])
  @@index([type])
  @@index([createdAt])
}

// ========================================
// PAYOUTS
// ========================================

enum PayoutStatus {
  PENDING
  APPROVED
  PROCESSING
  PAID
  FAILED
  REJECTED
}

model Payout {
  id             String       @id @default(cuid())
  coachId        String
  amount         Int          // signed int cents
  currency       String       @default("CHF")
  status         PayoutStatus @default(PENDING)
  stripeTransferId String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  coach        User          @relation(fields: [coachId], references: [id], onDelete: Cascade)
  ledgerEntries LedgerEntry[]

  @@index([coachId])
  @@index([status])
  @@index([createdAt])
}

// ========================================
// PROMO CODES
// ========================================

enum PromoCodeType {
  FREE
  PERCENT
  FIXED
}

model PromoCode {
  id        String        @id @default(cuid())
  code      String        @unique
  type      PromoCodeType
  maxUses   Int?
  expiresAt DateTime?
  active    Boolean       @default(true)
  createdBy String
  createdAt DateTime      @default(now())

  createdByUser User             @relation("PromoCodeCreatedBy", fields: [createdBy], references: [id], onDelete: Cascade)
  redemptions    PromoRedemption[]

  @@index([active])
  @@index([expiresAt])
  @@index([createdBy])
}

model PromoRedemption {
  id           String   @id @default(cuid())
  promoCodeId  String
  userId       String
  transactionId String @unique // idempotent per transaction
  redeemedAt   DateTime @default(now())

  promoCode   PromoCode   @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([promoCodeId])
  @@index([userId])
  @@index([redeemedAt])
}

// ========================================
// COACH SUBSCRIPTION (ENTITLEMENT)
// ========================================

enum CoachSubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELED
  EXPIRED
}

model CoachSubscription {
  id        String                  @id @default(cuid())
  coachId   String                  @unique
  status    CoachSubscriptionStatus @default(INACTIVE)
  expiresAt DateTime?
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt

  coach User @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([expiresAt])
}

// ========================================
// LIVE SESSION STATE (TEMPS RÉEL PERSISTÉ)
// ========================================

model LiveSessionState {
  id          String   @id @default(cuid())
  sessionId   String   @unique
  
  // État de lecture
  isPlaying   Boolean  @default(false)
  currentTime Float    @default(0)  // Position en secondes
  volume      Int      @default(80) // 0-100
  
  // Métadonnées
  lastEventBy String?  // ID du coach qui a émis le dernier event
  lastEventAt DateTime @default(now())
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([sessionId])
}

